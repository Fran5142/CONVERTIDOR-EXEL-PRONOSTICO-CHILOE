<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PronÃ³stico ChiloÃ© Oriental â†’ Excel</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #0e1621;
  color: #ffffff;
  padding: 20px;
}
.container { max-width: 900px; margin: auto; }
textarea {
  width: 100%;
  height: 350px;
  background: #ffffff;
  color: #000000;
  border: 2px solid #1e90ff;
  padding: 15px;
  border-radius: 8px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 14px;
}
.controls {
  margin-top: 15px;
  background: #162130;
  padding: 20px;
  border-radius: 8px;
  position: relative;
}
button {
  background: #1e90ff;
  border: none;
  color: white;
  padding: 12px 25px;
  cursor: pointer;
  font-weight: bold;
  border-radius: 4px;
}
button:hover { background: #0077e6; }
h2 { color: #1e90ff; margin-bottom: 10px; }
p { color: #bdc3c7; }

/* Estilo de la Firma */
.firma {
  margin-top: 25px;
  text-align: right;
  font-style: italic;
  color: #8e959b;
  font-size: 0.9em;
  border-top: 1px solid #34495e;
  padding-top: 10px;
}
</style>
</head>

<body>

<div class="container">
  <h2>ðŸ“Š Procesador MeteorolÃ³gico: ChiloÃ© Oriental</h2>
  <p>Pega el informe en el cuadro blanco y carga tu plantilla Excel.</p>

  <textarea id="texto" placeholder="Pegue aquÃ­ el informe meteorolÃ³gico marÃ­timo..."></textarea>
  
  <div class="controls">
    <input type="file" id="excel" accept=".xlsx">
    <button onclick="procesar()">Procesar y Guardar Excel</button>
    
    <div class="firma">
      Creado por Cabo 1Âº (Met.) Francisco Salas MuÃ±oz - 03/02/2026
    </div>
  </div>
</div>

<script>
// --- FUNCIONES DE LIMPIEZA ---
function limpiarTextoPro(t, etiquetaAEliminar = "") {
  if (!t) return "";
  let limpio = t.replace(/\r?\n|\r/g, " ").replace(/\s+/g, " ").trim();
  if (etiquetaAEliminar) {
    const regexEtiqueta = new RegExp("^" + etiquetaAEliminar + "\\s+", "i");
    limpio = limpio.replace(regexEtiqueta, "");
  }
  limpio = limpio.replace(/MET\d+[A-Z]+/gi, "").trim();
  return limpio.replace(/[.,]$/, "").trim();
}

function limpiarBasuraZonas(t) {
  let limpio = t.replace(/PUERTO MONTT A ISLA BUTA CHAUQUES.*|ISLA BUTA CHAUQUES A ISLA SAN PEDRO.*|BOCA DEL GUAFO Y GOLFO CORCOVADO.*|MET\d+[A-Z]+/gi, "").trim();
  limpio = limpio.replace(/^MAR\s+/i, "");
  return limpio.replace(/[.,]$/, "").trim();
}

function procesar() {
  const areaTexto = document.getElementById("texto");
  const fullText = areaTexto.value;
  const archivo = document.getElementById("excel").files[0];

  if (!fullText || !archivo) {
    alert("Por favor, ingresa el texto y el archivo Excel.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const hoja = wb.Sheets[wb.SheetNames[0]];

    // 1. HORAS P1
    const regexValidez1 = /VALIDO DESDE\s+(\d{6})\s+HASTA\s+(\d{6})\s+HORA LOCAL/i;
    const matchValidez1 = fullText.match(regexValidez1);
    if (matchValidez1) {
      const h1 = matchValidez1[1] + " HORA LOCAL";
      const h2 = matchValidez1[2] + " HORA LOCAL";
      ["C2","C3","C4","C5"].forEach(c => { if(!hoja[c]) hoja[c]={t:'s'}; hoja[c].v=h1; });
      ["D2","D3","D4","D5"].forEach(c => { if(!hoja[c]) hoja[c]={t:'s'}; hoja[c].v=h2; });
    }

    // 2. SINÃ“PTICA
    const matchSinop = fullText.match(/SITUACION SINOPTICA:([\s\S]*?)PRONOSTICO:/i);
    if (matchSinop) {
      const sinop = limpiarTextoPro(matchSinop[1]);
      ["E2","E3","E4","E5"].forEach(c => { if(!hoja[c]) hoja[c]={t:'s'}; hoja[c].v=sinop; });
    }

    // 3. PERIODOS Y HORAS P2
    const regexSep = /PRONOSTICO VALIDO DESDE\s+(\d{6})\s+HASTA\s+(\d{6})\s+HORA LOCAL\./i;
    const partes = fullText.split(regexSep);
    const periodo1 = partes[0];
    
    if (partes.length >= 4) {
      hoja["L6"] = { t: 's', v: partes[1] };
      hoja["M6"] = { t: 's', v: partes[2] };
      const periodo2 = partes[3];
      const matchCH3_P2 = periodo2.match(/\(CH 3\):([\s\S]*?)(?=MET\d+|EMITIDO:|$)/i);
      if (matchCH3_P2) {
        const bloqueP2 = matchCH3_P2[1];
        const p2p = bloqueP2.split(/VTO/i);
        if (p2p.length > 1) {
          hoja["O6"] = { t: 's', v: limpiarTextoPro(p2p[0]) };
          hoja["R6"] = { t: 's', v: limpiarTextoPro(p2p[1], "VTO") };
        }
      }
    }

    // 4. ZONAS P1
    const zonasCfg = [
      { inicio: "\\(CH 1\\):", fin: "ISLA BUTA CHAUQUES", celdas: ["G3", "H3", "I3", "J3"] },
      { inicio: "\\(CH 2\\):", fin: "BOCA DEL GUAFO", celdas: ["G4", "H4", "I4", "J4"] },
      { inicio: "\\(CH 3\\):", fin: "$", celdas: ["G5", "H5", "I5", "J5"] } 
    ];

    zonasCfg.forEach(z => {
      const r = new RegExp(z.inicio + "([\\s\\S]*?)(?=" + z.fin + "|$)", "i");
      const m = periodo1.match(r);
      if (m) {
        const b = m[1];
        const fieldN = b.match(/([\s\S]*?)VIS/i);
        const fieldVi = b.match(/VIS([\s\S]*?)VTO/i);
        const fieldVt = b.match(/VTO([\s\S]*?)MAR/i);
        const fieldMa = b.match(/MAR([\s\S]*)$/i);
        if (fieldN) hoja[z.celdas[0]] = { t: 's', v: limpiarTextoPro(fieldN[1]) };
        if (fieldVi) hoja[z.celdas[1]] = { t: 's', v: limpiarTextoPro(fieldVi[1], "VIS") };
        if (fieldVt) hoja[z.celdas[2]] = { t: 's', v: limpiarTextoPro(fieldVt[1], "VTO") };
        if (fieldMa) hoja[z.celdas[3]] = { t: 's', v: limpiarBasuraZonas(fieldMa[1]) };
      }
    });

    // Guardar archivo
    XLSX.writeFile(wb, "Pronostico_Final.xlsx");
    
    // Limpieza y aviso
    areaTexto.value = ""; 
    alert("Procesado con Ã©xito");
  };
  reader.readAsArrayBuffer(archivo);
}
</script>

</body>
</html>
