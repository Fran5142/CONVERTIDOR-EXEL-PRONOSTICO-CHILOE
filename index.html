<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pron√≥stico Chilo√© Oriental ‚Üí Excel</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #0e1621;
  color: #ffffff;
  padding: 20px;
}
.container { max-width: 900px; margin: auto; }
/* Estilo solicitado: Fondo blanco y letra negra */
textarea {
  width: 100%;
  height: 350px;
  background: #ffffff;
  color: #000000;
  border: 2px solid #1e90ff;
  padding: 15px;
  border-radius: 8px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 14px;
}
.controls {
  margin-top: 15px;
  background: #162130;
  padding: 20px;
  border-radius: 8px;
}
button {
  background: #1e90ff;
  border: none;
  color: white;
  padding: 12px 25px;
  cursor: pointer;
  font-weight: bold;
  border-radius: 4px;
}
button:hover { background: #0077e6; }
h2 { color: #1e90ff; margin-bottom: 10px; }
p { color: #bdc3c7; }
</style>
</head>

<body>

<div class="container">
  <h2>üìä Procesador Meteorol√≥gico: Chilo√© Oriental</h2>
  <p>Pega el informe en el cuadro blanco. Se limpiar√°n etiquetas (VIS, VTO, MAR) y c√≥digos MET.</p>

  <textarea id="texto" placeholder="Pegue aqu√≠ el informe meteorol√≥gico mar√≠timo..."></textarea>
  
  <div class="controls">
    <input type="file" id="excel" accept=".xlsx">
    <button onclick="procesar()">Procesar y Guardar Excel</button>
  </div>
</div>

<script>
// --- FUNCIONES DE LIMPIEZA ---

function limpiarTextoPro(t, etiquetaAEliminar = "") {
  if (!t) return "";
  
  // 1. Quitar saltos de l√≠nea y espacios extra
  let limpio = t.replace(/\r?\n|\r/g, " ").replace(/\s+/g, " ").trim();
  
  // 2. Eliminar la etiqueta espec√≠fica (VIS, VTO o MAR)
  if (etiquetaAEliminar) {
    const regexEtiqueta = new RegExp("^" + etiquetaAEliminar + "\\s+", "i");
    limpio = limpio.replace(regexEtiqueta, "");
  }

  // 3. Eliminar c√≥digos tipo MET008FF, MET106MD, etc.
  limpio = limpio.replace(/MET\d+[A-Z]+/gi, "").trim();
  
  // 4. Elimina punto o coma final
  return limpio.replace(/[.,]$/, "").trim();
}

function limpiarBasuraZonas(t) {
  let limpio = t.replace(/PUERTO MONTT A ISLA BUTA CHAUQUES.*|ISLA BUTA CHAUQUES A ISLA SAN PEDRO.*|BOCA DEL GUAFO Y GOLFO CORCOVADO.*|MET\d+[A-Z]+/gi, "").trim();
  limpio = limpio.replace(/^MAR\s+/i, "");
  return limpio.replace(/[.,]$/, "").trim();
}

function procesar() {
  const areaTexto = document.getElementById("texto");
  const fullText = areaTexto.value;
  const archivo = document.getElementById("excel").files[0];

  if (!fullText || !archivo) {
    alert("Por favor, ingresa el texto y el archivo Excel.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const hoja = wb.Sheets[wb.SheetNames[0]];

    // --- 1. HORAS PRIMER PERIODO (C2:C5 y D2:D5) ---
    const regexValidez1 = /VALIDO DESDE\s+(\d{6})\s+HASTA\s+(\d{6})\s+HORA LOCAL/i;
    const matchValidez1 = fullText.match(regexValidez1);

    if (matchValidez1) {
      const horaInicio1 = matchValidez1[1] + " HORA LOCAL";
      const horaFin1 = matchValidez1[2] + " HORA LOCAL";
      ["C2", "C3", "C4", "C5"].forEach(celda => {
        if(!hoja[celda]) hoja[celda] = { t: 's' };
        hoja[celda].v = horaInicio1;
      });
      ["D2", "D3", "D4", "D5"].forEach(celda => {
        if(!hoja[celda]) hoja[celda] = { t: 's' };
        hoja[celda].v = horaFin1;
      });
    }

    // --- 2. SITUACI√ìN SIN√ìPTICA (E2:E5) ---
    const matchSinop = fullText.match(/SITUACION SINOPTICA:([\s\S]*?)PRONOSTICO:/i);
    if (matchSinop) {
      const sinop = limpiarTextoPro(matchSinop[1]);
      ["E2", "E3", "E4", "E5"].forEach(c => {
        if(!hoja[c]) hoja[c] = { t: 's' };
        hoja[c].v = sinop;
      });
    }

    // --- 3. SEPARACI√ìN DE PERIODOS ---
    const regexSeparador = /PRONOSTICO VALIDO DESDE\s+(\d{6})\s+HASTA\s+(\d{6})\s+HORA LOCAL\./i;
    const partesPeriodos = fullText.split(regexSeparador);
    const periodo1 = partesPeriodos[0];
    
    if (partesPeriodos.length >= 4) {
      // --- 4. HORAS SEGUNDO PERIODO (L6 y M6) ---
      hoja["L6"] = { t: 's', v: partesPeriodos[1] };
      hoja["M6"] = { t: 's', v: partesPeriodos[2] };

      const periodo2 = partesPeriodos[3];

      // --- 5. CH 3 SEGUNDO PERIODO (O6 y R6) ---
      const matchCH3_P2 = periodo2.match(/\(CH 3\):([\s\S]*?)(?=MET\d+|EMITIDO:|$)/i);
      if (matchCH3_P2) {
        const bloqueP2 = matchCH3_P2[1];
        const p2Partes = bloqueP2.split(/VTO/i);
        if (p2Partes.length > 1) {
          hoja["O6"] = { t: 's', v: limpiarTextoPro(p2Partes[0]) };
          hoja["R6"] = { t: 's', v: limpiarTextoPro(p2Partes[1], "VTO") };
        }
      }
    }

    // --- 6. PRON√ìSTICO PRIMER PERIODO (CH1, CH2, CH3) ---
    const zonasCfg = [
      { id: "CH 1", inicio: "\\(CH 1\\):", fin: "ISLA BUTA CHAUQUES", celdas: ["G3", "H3", "I3", "J3"] },
      { id: "CH 2", inicio: "\\(CH 2\\):", fin: "BOCA DEL GUAFO", celdas: ["G4", "H4", "I4", "J4"] },
      { id: "CH 3", inicio: "\\(CH 3\\):", fin: "$", celdas: ["G5", "H5", "I5", "J5"] } 
    ];

    zonasCfg.forEach(z => {
      const regex = new RegExp(z.inicio + "([\\s\\S]*?)(?=" + z.fin + "|$)", "i");
      const match = periodo1.match(regex);
      
      if (match) {
        const bloque = match[1];
        const n = bloque.match(/([\s\S]*?)VIS/i);
        const vi = bloque.match(/VIS([\s\S]*?)VTO/i);
        const vt = bloque.match(/VTO([\s\S]*?)MAR/i);
        const ma = bloque.match(/MAR([\s\S]*)$/i);

        if (n) hoja[z.celdas[0]] = { t: 's', v: limpiarTextoPro(n[1]) };
        if (vi) hoja[z.celdas[1]] = { t: 's', v: limpiarTextoPro(vi[1], "VIS") };
        if (vt) hoja[z.celdas[2]] = { t: 's', v: limpiarTextoPro(vt[1], "VTO") };
        if (ma) hoja[z.celdas[3]] = { t: 's', v: limpiarBasuraZonas(ma[1]) };
      }
    });

    // Descargar y limpiar el √°rea de texto
    XLSX.writeFile(wb, "6.- Chilo√© Oriental.xlsx");
    areaTexto.value = ""; // Deja el cuadro en blanco para el pr√≥ximo informe
  };
  reader.readAsArrayBuffer(archivo);
}
</script>

</body>
</html>
