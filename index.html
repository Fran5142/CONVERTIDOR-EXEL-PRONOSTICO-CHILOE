<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pron√≥stico Chilo√© Oriental ‚Üí Excel</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0e1621;
  color: #ffffff;
  padding: 20px;
}
textarea {
  width: 100%;
  height: 360px;
}
input, button {
  margin-top: 10px;
  padding: 8px;
}
button {
  background: #1e90ff;
  border: none;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<h2>üìä Pron√≥stico Meteorol√≥gico Mar√≠timo ‚Äì Chilo√© Oriental</h2>

<textarea id="texto" placeholder="Pega aqu√≠ el informe meteorol√≥gico completo"></textarea>
<br>
<input type="file" id="excel" accept=".xlsx">
<br><br>

<button onclick="procesar()">Procesar y descargar Excel</button>

<script>
// ==================================================
// üîí ZONAS PRIMER PER√çODO
// ==================================================
const ZONAS = [
  {
    inicio: "\\(CH 1\\):",
    fin: "\\(CH 2\\):",
    celdas: { NUB: "G3", VIS: "H3", VTO: "I3", MAR: "J3" }
  },
  {
    inicio: "\\(CH 2\\):",
    fin: "\\(CH 3\\):",
    celdas: { NUB: "G4", VIS: "H4", VTO: "I4", MAR: "J4" }
  },
  {
    inicio: "\\(CH 3\\):",
    fin: "PRONOSTICO VALIDO DESDE",
    celdas: { NUB: "G5", VIS: "H5", VTO: "I5", MAR: "J5" }
  }
];

// üëâ SITUACI√ìN SIN√ìPTICA ‚Üí E2:E5
const CELDAS_SINOPTICA = ["E2", "E3", "E4", "E5"];

// ==================================================
// üß† UTILIDADES
// ==================================================
function limpiar(txt) {
  return txt.replace(/\n+/g, " ").replace(/\s+/g, " ").trim();
}

function limpiarFinal(txt) {
  return txt.trim().replace(/[.,]$/, "");
}

function obtenerZona(texto, inicio, fin) {
  const r = new RegExp(inicio + "([\\s\\S]*?)" + fin, "i");
  const m = texto.match(r);
  return m ? limpiar(m[1]) : "";
}

function extraerCampos(zona) {
  const r = /^(.*?)VIS(.*?)VTO(.*?)MAR([\s\S]*)$/i;
  const m = zona.match(r);
  if (!m) return null;

  return {
    nub: limpiarFinal(limpiar(m[1])),
    vis: limpiarFinal(limpiar(m[2])),
    vto: limpiarFinal(limpiar(m[3])),
    mar: limpiarFinal(limpiar(m[4]))
  };
}

// üîπ SITUACI√ìN SIN√ìPTICA GENERAL
function extraerSituacionSinoptica(texto) {
  const r = /SITUACION SINOPTICA:\s*([^\n]+)/i;
  const m = texto.match(r);
  return m ? limpiarFinal(limpiar(m[1])) : "";
}

// ==================================================
// üî• CH3 SEGUNDO PER√çODO
// ==================================================
function extraerCH3SegundoPeriodo(texto) {
  const r = /PRONOSTICO VALIDO DESDE[\s\S]*?\(CH 3\):\s*([^\n]+)/i;
  const m = texto.match(r);
  if (!m) return null;

  const linea = limpiarFinal(limpiar(m[1]));

  const partes = linea.split("VTO");
  if (partes.length < 2) return null;

  return {
    estado: limpiarFinal(partes[0]),
    vto: limpiarFinal("VTO " + partes[1])
  };
}

// ==================================================
// ‚ñ∂ PROCESAR
// ==================================================
function procesar() {
  const texto = document.getElementById("texto").value.toUpperCase();
  const archivo = document.getElementById("excel").files[0];

  if (!archivo) {
    alert("Debes subir un archivo Excel");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
    const hoja = wb.Sheets[wb.SheetNames[0]];

    // üîπ PRIMER PER√çODO (CH1‚ÄìCH3)
    ZONAS.forEach(z => {
      const zonaTxt = obtenerZona(texto, z.inicio, z.fin);
      if (!zonaTxt) return;

      const d = extraerCampos(zonaTxt);
      if (!d) return;

      hoja[z.celdas.NUB] = { t: "s", v: d.nub };
      hoja[z.celdas.VIS] = { t: "s", v: d.vis };
      hoja[z.celdas.VTO] = { t: "s", v: d.vto };
      hoja[z.celdas.MAR] = { t: "s", v: d.mar };
    });

    // üîπ SITUACI√ìN SIN√ìPTICA
    const sinoptica = extraerSituacionSinoptica(texto);
    if (sinoptica) {
      CELDAS_SINOPTICA.forEach(c => hoja[c] = { t: "s", v: sinoptica });
    }

    // üî• CH3 SEGUNDO PER√çODO ‚Üí O6 / R6
    const ch3b = extraerCH3SegundoPeriodo(texto);
    if (ch3b) {
      hoja["O6"] = { t: "s", v: ch3b.estado };
      hoja["R6"] = { t: "s", v: ch3b.vto };
    }

    XLSX.writeFile(wb, "Pronostico_Chiloe_Oriental.xlsx");
  };

  reader.readAsArrayBuffer(archivo);
}
</script>

</body>
</html>
