<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pron√≥stico Chilo√© Oriental ‚Üí Excel</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #0e1621;
  color: #ffffff;
  padding: 20px;
}
.container { max-width: 900px; margin: auto; }
textarea {
  width: 100%;
  height: 350px;
  background: #1b2838;
  color: #fff;
  border: 1px solid #34495e;
  padding: 15px;
  border-radius: 8px;
  font-family: monospace;
}
.controls {
  margin-top: 15px;
  background: #162130;
  padding: 20px;
  border-radius: 8px;
}
button {
  background: #1e90ff;
  border: none;
  color: white;
  padding: 12px 25px;
  cursor: pointer;
  font-weight: bold;
  border-radius: 4px;
}
button:hover { background: #0077e6; }
h2 { color: #1e90ff; margin-bottom: 10px; }
</style>
</head>

<body>

<div class="container">
  <h2>üìä Procesador Meteorol√≥gico: Chilo√© Oriental</h2>
  <p>Pega el informe completo. Se eliminar√°n comas y puntos finales autom√°ticamente.</p>

  <textarea id="texto" placeholder="Pega el informe completo aqu√≠..."></textarea>
  
  <div class="controls">
    <input type="file" id="excel" accept=".xlsx">
    <button onclick="procesar()">Procesar y Descargar Excel</button>
  </div>
</div>

<script>
// --- FUNCIONES DE LIMPIEZA ---

/**
 * 1. Limpia espacios, saltos de l√≠nea y
 * 2. Elimina Comas (,) o Puntos (.) al final de la frase.
 */
function limpiarTextoPro(t) {
  if (!t) return "";
  // Quitar saltos de l√≠nea y espacios extra
  let limpio = t.replace(/\r?\n|\r/g, " ").replace(/\s+/g, " ").trim();
  // Quitar punto o coma final si existe
  return limpio.replace(/[.,]$/, "").trim();
}

/**
 * Elimina restos de encabezados de zonas que se colan por error en el campo MAR
 */
function limpiarBasuraZonas(t) {
  let limpio = t.replace(/PUERTO MONTT A ISLA BUTA CHAUQUES.*|ISLA BUTA CHAUQUES A ISLA SAN PEDRO.*|BOCA DEL GUAFO Y GOLFO CORCOVADO.*/gi, "").trim();
  return limpio.replace(/[.,]$/, "").trim(); // Re-limpiar puntuaci√≥n tras quitar basura
}

function procesar() {
  const fullText = document.getElementById("texto").value;
  const archivo = document.getElementById("excel").files[0];

  if (!fullText || !archivo) {
    alert("Por favor, ingresa el texto y el archivo Excel.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const hoja = wb.Sheets[wb.SheetNames[0]];

    // --- 1. SITUACI√ìN SIN√ìPTICA ---
    const matchSinop = fullText.match(/SITUACION SINOPTICA:([\s\S]*?)PRONOSTICO:/i);
    if (matchSinop) {
      const sinop = limpiarTextoPro(matchSinop[1]);
      ["E2", "E3", "E4", "E5"].forEach(c => { 
        hoja[c] = { t: 's', v: sinop }; 
      });
    }

    // --- 2. DIVISI√ìN POR PER√çODOS ---
    const partesPeriodos = fullText.split(/PRONOSTICO VALIDO DESDE \d{6} HASTA \d{6} HORA LOCAL\./i);
    const periodo1 = partesPeriodos[0];
    const periodo2 = partesPeriodos[1] || "";

    // CONFIGURACI√ìN DE ZONAS (PERIODO 1)
    const zonasCfg = [
      { id: "CH 1", inicio: "\\(CH 1\\):", fin: "ISLA BUTA CHAUQUES", celdas: ["G3", "H3", "I3", "J3"] },
      { id: "CH 2", inicio: "\\(CH 2\\):", fin: "BOCA DEL GUAFO", celdas: ["G4", "H4", "I4", "J4"] },
      { id: "CH 3", inicio: "\\(CH 3\\):", fin: "$", celdas: ["G5", "H5", "I5", "J5"] } 
    ];

    zonasCfg.forEach(z => {
      const regex = new RegExp(z.inicio + "([\\s\\S]*?)(?=" + z.fin + "|$)", "i");
      const match = periodo1.match(regex);
      
      if (match) {
        const bloque = match[1];
        const n = bloque.match(/([\s\S]*?)VIS/i);
        const vi = bloque.match(/VIS([\s\S]*?)VTO/i);
        const vt = bloque.match(/VTO([\s\S]*?)MAR/i);
        const ma = bloque.match(/MAR([\s\S]*)$/i);

        if (n) hoja[z.celdas[0]] = { t: 's', v: limpiarTextoPro(n[1]) };
        if (vi) hoja[z.celdas[1]] = { t: 's', v: "VIS " + limpiarTextoPro(vi[1]) };
        if (vt) hoja[z.celdas[2]] = { t: 's', v: "VTO " + limpiarTextoPro(vt[1]) };
        if (ma) hoja[z.celdas[3]] = { t: 's', v: "MAR " + limpiarBasuraZonas(ma[1]) };
      }
    });

    // --- 3. SEGUNDO PERIODO (CH 3 -> Celdas O6 y R6) ---
    const matchCH3_P2 = periodo2.match(/\(CH 3\):([\s\S]*?)(?=MET008FF|EMITIDO:|$)/i);
    if (matchCH3_P2) {
      const bloqueP2 = matchCH3_P2[1];
      const p2Partes = bloqueP2.split(/VTO/i);
      if (p2Partes.length > 1) {
        hoja["O6"] = { t: 's', v: limpiarTextoPro(p2Partes[0]) };
        hoja["R6"] = { t: 's', v: "VTO " + limpiarTextoPro(p2Partes[1]) };
      }
    }

    XLSX.writeFile(wb, "6.- Chilo√© Oriental.xlsx");
  };
  reader.readAsArrayBuffer(archivo);
}
</script>

</body>
</html>



