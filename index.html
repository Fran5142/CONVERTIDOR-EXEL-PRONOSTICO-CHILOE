<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pron√≥stico Chilo√© Oriental ‚Üí Excel</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* --- ESTILO VISUAL: MODERN NAVY DARK MODE --- */
:root {
  --bg-navy-dark: #0a192f;
  --bg-navy-light: #172a45;
  --text-light: #e6f1ff;
  --text-muted: #8892b0;
  --accent-cyan: #64ffda;
  --accent-blue: #00b4d8;
}

body {
  font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
  /* Degradado de azul marino profundo */
  background: linear-gradient(135deg, var(--bg-navy-dark) 0%, #112240 100%);
  color: var(--text-light);
  padding: 40px 20px;
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.container {
  width: 100%;
  max-width: 900px;
  /* Efecto de vidrio oscuro semitransparente */
  background: rgba(23, 42, 69, 0.85);
  backdrop-filter: blur(10px);
  padding: 45px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

h2 {
  color: var(--accent-cyan); /* T√≠tulo en color cian brillante */
  margin-top: 0;
  font-weight: 700;
  text-align: center;
  letter-spacing: 1px;
  text-transform: uppercase;
}

p {
  color: var(--text-muted);
  text-align: center;
  margin-bottom: 30px;
  font-size: 1.1em;
}

/* EL √ÅREA DE TEXTO BLANCA SOLICITADA */
textarea {
  width: 100%;
  height: 300px;
  background: #ffffff;
  color: #0a192f; /* Texto oscuro sobre fondo blanco */
  border: 3px solid transparent;
  padding: 20px;
  border-radius: 12px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 14px;
  resize: vertical;
  transition: all 0.3s ease;
  box-sizing: border-box;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

textarea:focus {
  outline: none;
  border-color: var(--accent-cyan); /* Borde cian al enfocar */
  box-shadow: 0 0 20px rgba(100, 255, 218, 0.25); /* Resplandor suave */
}

.controls {
  margin-top: 30px;
  background: rgba(10, 25, 47, 0.5); /* Fondo m√°s oscuro para controles */
  padding: 30px;
  border-radius: 15px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  display: flex;
  flex-direction: column;
  gap: 20px;
  align-items: center;
}

input[type="file"] {
  padding: 12px;
  background: rgba(255, 255, 255, 0.1); /* Input semitransparente */
  color: var(--accent-cyan);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  width: 100%;
  max-width: 450px;
  transition: all 0.3s;
}
input[type="file"]:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--accent-cyan);
}

button {
  /* Bot√≥n con degradado vibrante */
  background: linear-gradient(to right, var(--accent-cyan), var(--accent-blue));
  border: none;
  color: var(--bg-navy-dark); /* Texto oscuro para contraste */
  padding: 15px 50px;
  cursor: pointer;
  font-weight: 800;
  border-radius: 50px;
  font-size: 16px;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(0, 180, 216, 0.3);
}

button:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 10px 25px rgba(0, 180, 216, 0.5);
}

button:active {
  transform: translateY(1px);
}

/* Estilo de la Firma */
.firma {
  margin-top: 25px;
  text-align: right;
  font-style: italic;
  color: var(--text-muted);
  font-size: 0.9em;
  width: 100%;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding-top: 20px;
  opacity: 0.7;
}
</style>
</head>

<body>

<div class="container">
  <h2>üìä Procesador Meteorol√≥gico: Chilo√© Oriental</h2>
  <p>Pegue el informe en el cuadro blanco a continuaci√≥n.</p>

  <textarea id="texto" placeholder="Pegue aqu√≠ el informe meteorol√≥gico mar√≠timo..."></textarea>
  
  <div class="controls">
    <input type="file" id="excel" accept=".xlsx">
    <button onclick="procesar()">PROCESAR Y GUARDAR EXCEL</button>
    
    <div class="firma">
      Creado por Cabo 1¬∫ (Met.) Francisco Salas Mu√±oz - 03/02/2026
    </div>
  </div>
</div>

<script>
// --- FUNCIONES DE LIMPIEZA ---
function limpiarTextoPro(t, etiquetaAEliminar = "") {
  if (!t) return "";
  let limpio = t.replace(/\r?\n|\r/g, " ").replace(/\s+/g, " ").trim();
  if (etiquetaAEliminar) {
    const regexEtiqueta = new RegExp("^" + etiquetaAEliminar + "\\s+", "i");
    limpio = limpio.replace(regexEtiqueta, "");
  }
  limpio = limpio.replace(/MET\d+[A-Z]+/gi, "").trim();
  return limpio.replace(/[.,]$/, "").trim();
}

function limpiarBasuraZonas(t) {
  let limpio = t.replace(/PUERTO MONTT A ISLA BUTA CHAUQUES.*|ISLA BUTA CHAUQUES A ISLA SAN PEDRO.*|BOCA DEL GUAFO Y GOLFO CORCOVADO.*|MET\d+[A-Z]+/gi, "").trim();
  limpio = limpio.replace(/^MAR\s+/i, "");
  return limpio.replace(/[.,]$/, "").trim();
}

function procesar() {
  const areaTexto = document.getElementById("texto");
  const fullText = areaTexto.value;
  const archivo = document.getElementById("excel").files[0];

  if (!fullText || !archivo) {
    alert("Por favor, ingresa el texto y el archivo Excel.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const hoja = wb.Sheets[wb.SheetNames[0]];

    // 1. HORAS P1
    const regexValidez1 = /VALIDO DESDE\s+(\d{6})\s+HASTA\s+(\d{6})\s+HORA LOCAL/i;
    const matchValidez1 = fullText.match(regexValidez1);
    if (matchValidez1) {
      const h1 = matchValidez1[1] + " HORA LOCAL";
      const h2 = matchValidez1[2] + " HORA LOCAL";
      ["C2","C3","C4","C5"].forEach(c => { if(!hoja[c]) hoja[c]={t:'s'}; hoja[c].v=h1; });
      ["D2","D3","D4","D5"].forEach(c => { if(!hoja[c]) hoja[c]={t:'s'}; hoja[c].v=h2; });
    }

    // 2. SIN√ìPTICA
    const matchSinop = fullText.match(/SITUACION SINOPTICA:([\s\S]*?)PRONOSTICO:/i);
    if (matchSinop) {
      const sinop = limpiarTextoPro(matchSinop[1]);
      ["E2","E3","E4","E5"].forEach(c => { if(!hoja[c]) hoja[c]={t:'s'}; hoja[c].v=sinop; });
    }

    // 3. PERIODOS Y HORAS P2
    const regexSep = /PRONOSTICO VALIDO DESDE\s+(\d{6})\s+HASTA\s+(\d{6})\s+HORA LOCAL\./i;
    const partes = fullText.split(regexSep);
    const periodo1 = partes[0];
    
    if (partes.length >= 4) {
      hoja["L6"] = { t: 's', v: partes[1] };
      hoja["M6"] = { t: 's', v: partes[2] };
      const periodo2 = partes[3];
      const matchCH3_P2 = periodo2.match(/\(CH 3\):([\s\S]*?)(?=MET\d+|EMITIDO:|$)/i);
      if (matchCH3_P2) {
        const bloqueP2 = matchCH3_P2[1];
        const p2p = bloqueP2.split(/VTO/i);
        if (p2p.length > 1) {
          hoja["O6"] = { t: 's', v: limpiarTextoPro(p2p[0]) };
          hoja["R6"] = { t: 's', v: limpiarTextoPro(p2p[1], "VTO") };
        }
      }
    }

    // 4. ZONAS P1
    const zonasCfg = [
      { inicio: "\\(CH 1\\):", fin: "ISLA BUTA CHAUQUES", celdas: ["G3", "H3", "I3", "J3"] },
      { inicio: "\\(CH 2\\):", fin: "BOCA DEL GUAFO", celdas: ["G4", "H4", "I4", "J4"] },
      { inicio: "\\(CH 3\\):", fin: "$", celdas: ["G5", "H5", "I5", "J5"] } 
    ];

    zonasCfg.forEach(z => {
      const r = new RegExp(z.inicio + "([\\s\\S]*?)(?=" + z.fin + "|$)", "i");
      const m = periodo1.match(r);
      if (m) {
        const b = m[1];
        const fieldN = b.match(/([\s\S]*?)VIS/i);
        const fieldVi = b.match(/VIS([\s\S]*?)VTO/i);
        const fieldVt = b.match(/VTO([\s\S]*?)MAR/i);
        const fieldMa = b.match(/MAR([\s\S]*)$/i);
        if (fieldN) hoja[z.celdas[0]] = { t: 's', v: limpiarTextoPro(fieldN[1]) };
        if (fieldVi) hoja[z.celdas[1]] = { t: 's', v: limpiarTextoPro(fieldVi[1], "VIS") };
        if (fieldVt) hoja[z.celdas[2]] = { t: 's', v: limpiarTextoPro(fieldVt[1], "VTO") };
        if (fieldMa) hoja[z.celdas[3]] = { t: 's', v: limpiarBasuraZonas(fieldMa[1]) };
      }
    });

    // Guardar archivo
    XLSX.writeFile(wb, "6.- Chilo√© Oriental.xlsx");
    
    // Limpieza y aviso
    areaTexto.value = ""; 
    alert("Procesado con √©xito");
  };
  reader.readAsArrayBuffer(archivo);
}
</script>

</body>
</html>
